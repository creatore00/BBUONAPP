<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Hours Summary</title>
    <style>
        body {
            /* Set the background color with gradient effect */
            background: linear-gradient(135deg, #4A90E2 0%, #B0E0E6 100%);
            margin: 0;
            font-family: Arial, sans-serif;
            text-align: center;
            text-transform: uppercase;
            color: #60a2ee; /* Text color */
        }

        table {
            width: 80%;
            border-collapse: separate;
            margin: 0 auto; /* This centers the table horizontally */
            background-color: #1E90FF; /* Blue background */
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); /* Added box shadow for depth */
        }

        th, td {
            text-align: center;
            padding: 12px;
            white-space: nowrap;
            background-color: #4A90E2; /* Light blue background */
            color: #fff; /* White text */
            font-weight: bold; /* Bold text */
        }

        .btn, .btn1 {
            background-color: #4A90E2; /* Light blue button background */
            color: #fff; /* White text */
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            align-self: center;
            margin-top: 10px;
            margin-bottom: 10px;
            transition: background-color 0.3s ease; /* Smooth color transition */
            font-size: 14px; /* Font size */
        }

        .btn:hover, .btn1:hover {
            background-color: #1E90FF; /* Darker blue button background on hover */
            transform: scale(1.05); /* Increase size by 5% */
            transition: transform 0.3s ease; /* Add smooth transition effect */
        }

        .draggable {
            cursor: pointer;
        }

        .dragging {
            opacity: 0.5;
        }

        .dragover {
            background-color: #70ace7; /* Lighter blue background */
        }

        .time-frame {
            margin-bottom: 5px;
            cursor: move;
            border: 1px solid transparent; /* Added for highlighting */
        }

        .selected {
            background-color: #70ace7; /* Lighter blue background */
            border-color: #ccc; /* Added for highlighting */
        }

        #timeFrameInput {
            display: none;
            position: absolute;
            background-color: rgba(176, 224, 230, 0.8); /* Light blue background */
            border: 1px solid #ccc;
            padding: 10px;
        }

        #timeFrameInput.show {
            display: block;
        }

        #popupMessage {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green background */
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            transition: opacity 0.3s ease; /* Smooth transition */
        }

        #popupMessage.show {
            display: block;
            opacity: 1;
        }

        #customWeekNavigation {
            margin-bottom: 10px; /* Add some space above the new line */
        }

        .date {
            background-color: #70ace7; /* Blue background */
            font-family: Arial, sans-serif;
            text-transform: uppercase;
            color: white;
            border-radius: 5px; /* Rounded corners */
            padding: 6px 12px; /* Adjust padding for better fit */
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2); /* Added shadow for depth */
        }

        /* Animation for table rows */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        tbody tr {
            animation: fadeInUp 0.5s ease;
        }

    </style>
</head>
<body>
<h1>Work Hours Summary</h1>
<div id="hoursSummary">
    <!-- Total hours, wage, tip, result before tax, tax, and result after tax will be displayed here -->
</div>

<footer>
    <div>
        <button id="submitBtn" onclick="downloadPDF()" class="btn">Downlaod</button>
    </div>
</footer>
<script>
    // Function to get the current month in the format 'YYYY-MM'
    function getCurrentMonth() {
        const currentDate = new Date();
        const year = currentDate.getFullYear();
        let month = currentDate.getMonth() + 1;
        month = month < 10 ? '0' + month : month;
        return `${year}-${month}`;
    }

    function retrieveAndPrintData() {
    const selectedMonth = getCurrentMonth();

    // Fetch data from both tables for the selected month
    Promise.all([
        fetch(`/rota?month=${selectedMonth}`).then(response => response.json()),
        fetch(`/tip?month=${selectedMonth}`).then(response => response.json())
    ]).then(([rotaData, tipData]) => {
// Merge tip data by employee name and sum the tip values
const tipMap = new Map();
tipData.forEach(tip => {
    console.log('Tip:', tip); // Log each tip to see its structure and value
    const name = tip.name + ' ' + tip.lastName;
    if (tipMap.has(name)) {
        tipMap.set(name, tipMap.get(name) + parseFloat(tip.tip)); // Convert tip to float and add
    } else {
        tipMap.set(name, parseFloat(tip.tip)); // Convert tip to float
    }
});
console.log('Tip Map:', tipMap); // Log the tipMap to see the accumulated values


        // Calculate total hours and total tips for each employee
        const employeeData = {};
        rotaData.forEach(entry => {
            const name = entry.name + ' ' + entry.lastName;
            if (!employeeData[name]) {
                employeeData[name] = {
                    name: entry.name,
                    lastName: entry.lastName,
                    wage: entry.wage,
                    totalHours: 0,
                    totalTips: 0
                };
            }
            // Calculate hours from time frames
            const startTime = new Date(`1970-01-01T${entry.startTime}Z`);
            const endTime = new Date(`1970-01-01T${entry.endTime}Z`);
            const hoursWorked = (endTime - startTime) / (1000 * 60 * 60);
            employeeData[name].totalHours += hoursWorked;
            employeeData[name].totalTips = tipMap.get(name) || 0; // Add tip value to total tips
        });

        // Print the data in the table
        const container = document.getElementById('hoursSummary');
        container.innerHTML = ''; // Clear existing content

        const table = document.createElement('table');
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>Name</th><th>Last Name</th><th>Wage</th><th>Total Hours</th><th>Total Tips</th>';
        table.appendChild(headerRow);

        Object.values(employeeData).forEach(employee => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${employee.name}</td><td>${employee.lastName}</td><td>${employee.wage}</td><td>${employee.totalHours.toFixed(2)}</td><td>${parseFloat(employee.totalTips).toFixed(2)}</td>`;

    table.appendChild(row);
});

        container.appendChild(table);
    }).catch(error => {
        console.error('Error retrieving and printing data:', error);
    });
}

    function downloadPDF() {
    // Get the HTML content of the table
    const tableHTML = document.getElementById('hoursSummary').innerHTML;

    // Get the current month in the format 'YYYY-MM'
    const selectedMonth = getCurrentMonth();

    // Send a request to the server to generate the PDF with the table content
    fetch('/generate-pdf', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ tableHTML, selectedMonth }) // Include selectedMonth in the request body
    })
    .then(response => {
        // Redirect to the generated PDF file
        window.location.href = `/download-pdf?selectedMonth=${selectedMonth}`; // Include selectedMonth in the query parameters
    })
    .catch(error => {
        console.error('Error generating PDF:', error);
    });
}

    window.onload = retrieveAndPrintData;
</script>
</body>
</html>

