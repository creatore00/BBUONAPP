<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="data:image/png;base64,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" type="image/png">

    <title>Work Hours Table</title>
    <style>
        body {
        /* Set the background color with gradient effect */
        background: linear-gradient(135deg, #4A90E2 0%, #B0E0E6 100%);
        margin: 0;
        font-family: Arial, sans-serif;
        text-align: center;
        text-transform: uppercase;
        color: #60a2ee; /* Text color */
    }
    
    table {
        width: 80%;
        margin: 0 auto; /* This centers the table horizontally */
        border-collapse: separate;
        border-spacing: 0;
        background-color: #1E90FF; /* Blue background */
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); /* Added box shadow for depth */
    }
    
    th, td {
        text-align: center;
        padding: 12px;
        white-space: nowrap;
        background-color: #4A90E2; /* Light blue background */
        color: #fff; /* White text */
        font-weight: bold; /* Bold text */
    }
    
    .btn, .btn1 {
        background-color: #4A90E2; /* Light blue button background */
        color: #fff; /* White text */
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        align-self: center;
        margin-top: 10px;
        margin-bottom: 10px;
        transition: background-color 0.3s ease; /* Smooth color transition */
        font-size: 14px; /* Font size */
    }
    
    .btn:hover, .btn1:hover {
        background-color: #1E90FF; /* Darker blue button background on hover */
        transform: scale(1.05); /* Increase size by 5% */
        transition: transform 0.3s ease; /* Add smooth transition effect */
    }
    
    .draggable {
        cursor: pointer;
    }
    
    .dragging {
        opacity: 0.5;
    }
    
    .dragover {
        background-color: #70ace7; /* Lighter blue background */
    }
    
    .time-frame {
        margin-bottom: 5px;
        cursor: move;
        border: 1px solid transparent; /* Added for highlighting */
    }
    
    .selected {
        background-color: #70ace7; /* Lighter blue background */
        border-color: #ccc; /* Added for highlighting */
    }
    
    #timeFrameInput {
        display: none;
        position: absolute;
        background-color: rgba(176, 224, 230, 0.8); /* Light blue background */
        border: 1px solid #ccc;
        padding: 10px;
    }
    
    #timeFrameInput.show {
        display: block;
    }
    
    #popupMessage {
        display: none;
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #4CAF50; /* Green background */
        color: white;
        padding: 10px;
        border-radius: 5px;
        z-index: 1000;
        transition: opacity 0.3s ease; /* Smooth transition */
    }
    
    #popupMessage.show {
        display: block;
        opacity: 1;
    }
    
    #customWeekNavigation {
        margin-bottom: 10px; /* Add some space above the new line */
    }
    
    .date {
        background-color: #70ace7; /* Blue background */
        font-family: Arial, sans-serif;
        text-transform: uppercase;
        color: white;
        border-radius: 5px; /* Rounded corners */
        padding: 6px 12px; /* Adjust padding for better fit */
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2); /* Added shadow for depth */
    }
    
    /* Animation for table rows */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    tbody tr {
        animation: fadeInUp 0.5s ease;
    }
    
    </style>
</head>
<body>
    <h1>Confirm Rota</h1>
    <!-- Date input field -->
    <label for="rotaDate">Select Date:</label>
    <input class="date" type="date" id="rotaDate">
    <button id="fetchRotaButton">Fetch Rota</button>
    <table id="rotaTable">
        <thead>
            <tr>
                <th>Day</th>
                <th>Name</th>
                <th>Last Name</th>
                <th>Designation</th>
                <th>Start and End Times</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data will be inserted here by JavaScript -->
        </tbody>
    </table>
    <button class="btn" id="confirmButton">Confirm Rota</button>
<script>
async function getRotaByDate(date) {
    const response = await fetch(`/confirmrota/api/rota?day=${encodeURIComponent(date)}`);
    if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
    }
    return await response.json();
}

function formatDateForDisplay(date) {
    const [year, month, day] = date.split('-');
    const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const dayOfWeek = daysOfWeek[new Date(date).getDay()];
    return `${day}/${month}/${year} (${dayOfWeek})`;
}

async function populateTable(date) {
    try {
        const formattedDate = formatDateForDisplay(date);
        console.log(`Fetching data for date: ${formattedDate}`);
        const [rotaData, confirmedRotaData] = await Promise.all([getRotaByDate(formattedDate), getConfirmedRota()]);
        console.log('Rota Data:', rotaData);
        console.log('Confirmed Rota Data:', confirmedRotaData);

        // Update the set to include the day in the unique key
        const confirmedRotaSet = new Set(
            confirmedRotaData.map(entry => `${entry.day} ${entry.name} ${entry.lastName} ${entry.designation} ${entry.startTime} ${entry.endTime}`)
        );
        console.log('Confirmed Rota Set:', confirmedRotaSet);

        const tableBody = document.querySelector('#rotaTable tbody');
        tableBody.innerHTML = ''; // Clear existing rows

        if (rotaData.length === 0) {
            console.log(`No data for date: ${formattedDate}`);
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 6;
            cell.textContent = "No data for today.";
            row.appendChild(cell);
            tableBody.appendChild(row);
        } else {
            // Sort rotaData by designation (FOH first, then BOH)
            rotaData.sort((a, b) => {
                if (a.designation === 'FOH' && b.designation === 'BOH') return -1;
                if (a.designation === 'BOH' && b.designation === 'FOH') return 1;
                return 0;
            });

            // Group rotaData by name, designation, and day
            const groupedData = rotaData.reduce((acc, entry) => {
                const key = `${entry.day} ${entry.name} ${entry.lastName} ${entry.designation}`;
                if (!acc[key]) {
                    acc[key] = {
                        day: entry.day,
                        name: entry.name,
                        lastName: entry.lastName,
                        wage: entry.wage,
                        designation: entry.designation,
                        times: []
                    };
                }
                acc[key].times.push({ startTime: entry.startTime, endTime: entry.endTime });
                return acc;
            }, {});

            console.log('Grouped Data:', groupedData);

            // Loop through each entry in groupedData
            Object.values(groupedData).forEach(entry => {
                const timesKey = entry.times.map(time => `${time.startTime} ${time.endTime}`).join(' ');
                const uniqueKey = `${entry.day} ${entry.name} ${entry.lastName} ${entry.designation} ${timesKey}`;
                console.log('Unique Key:', uniqueKey);

                if (!confirmedRotaSet.has(uniqueKey)) { // Check if the entry is not in ConfirmedRota
                    const row = document.createElement('tr');

                    const dayCell = document.createElement('td');
                    dayCell.textContent = entry.day;
                    row.appendChild(dayCell);

                    const nameCell = document.createElement('td');
                    nameCell.textContent = entry.name;
                    row.appendChild(nameCell);

                    const lastNameCell = document.createElement('td');
                    lastNameCell.textContent = entry.lastName;
                    row.appendChild(lastNameCell);

                    const designationCell = document.createElement('td');
                    designationCell.textContent = entry.designation;
                    row.appendChild(designationCell);

                    const timesCell = document.createElement('td');
                    entry.times.forEach((time, index) => {
                        const startTimeInput = document.createElement('input');
                        startTimeInput.type = 'time';
                        startTimeInput.value = time.startTime;
                        startTimeInput.dataset.timeIndex = index;
                        startTimeInput.dataset.name = entry.name;
                        startTimeInput.dataset.lastName = entry.lastName;
                        startTimeInput.dataset.designation = entry.designation;
                        startTimeInput.dataset.timeType = 'start'; // Attribute to distinguish start time
                        startTimeInput.classList.add('time-input');

                        const endTimeInput = document.createElement('input');
                        endTimeInput.type = 'time';
                        endTimeInput.value = time.endTime;
                        endTimeInput.dataset.timeIndex = index;
                        endTimeInput.dataset.name = entry.name;
                        endTimeInput.dataset.lastName = entry.lastName;
                        endTimeInput.dataset.designation = entry.designation;
                        endTimeInput.dataset.timeType = 'end'; // Attribute to distinguish end time
                        endTimeInput.classList.add('time-input');

                        timesCell.appendChild(startTimeInput);
                        timesCell.appendChild(document.createTextNode(' - '));
                        timesCell.appendChild(endTimeInput);
                        timesCell.appendChild(document.createElement('br'));
                    });
                    row.appendChild(timesCell);

                    tableBody.appendChild(row);
                } else {
                    console.log(`Entry already confirmed: ${uniqueKey}`);
                }
            });
        }
    } catch (error) {
        console.error('Error fetching rota data:', error);
    }
}

async function getConfirmedRota() {
    try {
        const response = await fetch('/confirmrota/api/confirmed-rota');
        return response.json();
    } catch (error) {
        console.error('Error fetching confirmed rota data:', error);
    }
}

function confirmRota() {
    try {
        const dateInput = document.getElementById('rotaDate').value;
        const tableRows = document.querySelectorAll('#rotaTable tbody tr');

        // Extract data from the table rows
        const formattedData = Array.from(tableRows).map(row => {
            const day = row.querySelector('td:nth-child(1)').textContent;
            const name = row.querySelector('td:nth-child(2)').textContent;
            const lastName = row.querySelector('td:nth-child(3)').textContent;
            const designation = row.querySelector('td:nth-child(4)').textContent;

            // Select all time inputs for this entry
            const timeInputs = row.querySelectorAll('input[data-name][data-last-name][data-designation]');

            // Process time inputs
            const times = Array.from(timeInputs).reduce((acc, input) => {
                const timeIndex = input.dataset.timeIndex;
                const timeType = input.dataset.timeType;

                if (!acc[timeIndex]) {
                    acc[timeIndex] = {};
                }

                if (input.type === 'time') {
                    if (timeType === 'start') {
                        acc[timeIndex].startTime = input.value;
                    } else if (timeType === 'end') {
                        acc[timeIndex].endTime = input.value;
                    }
                }

                return acc;
            }, {});

            // Convert the times object to an array
            const timesArray = Object.values(times);

            return {
                name: name,
                lastName: lastName,
                wage: row.querySelector('td:nth-child(5)').textContent,
                day: day,
                designation: designation,
                times: timesArray
            };
        });

        // Log formattedData to ensure it's correctly populated
        console.log('Formatted data:', formattedData);

        fetch('/confirmrota/confirm-rota', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formattedData) // Send formatted data to server
        }).then(response => {
            if (response.ok) {
                console.log('Rota confirmed successfully.');
            } else {
                response.text().then(errorText => {
                    console.error('Error confirming rota:', errorText);
                });
            }
        }).catch(error => {
            console.error('Error confirming rota:', error.message);
        });
    } catch (error) {
        console.error('Error confirming rota:', error.message);
    }
}

// Add event listener to fetch rota button
const fetchRotaButton = document.getElementById('fetchRotaButton');
fetchRotaButton.addEventListener('click', () => {
    const dateInput = document.getElementById('rotaDate').value;
    populateTable(dateInput);
});

// Add event listener to confirm button
const confirmButton = document.getElementById('confirmButton');
confirmButton.addEventListener('click', confirmRota);

// Fetch rota data when the page loads with today's date as default
window.onload = () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('rotaDate').value = today;
    populateTable(today);
};

</script>
</body>
</html>
